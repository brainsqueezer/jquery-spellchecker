/*
 * jquery.spellchecker.js - a simple jQuery Spell Checker
 * Copyright (c) 2009 Richard Willis
 * MIT license  : http://www.opensource.org/licenses/mit-license.php
 * Project      : http://jquery-spellchecker.googlecode.com
 * Contact      : willis.rh@gmail.com
 */
(function(b){b.fn.extend({spellchecker:function(a,c){return this.each(function(){if(b(this).data("spellchecker")&&b(this).data("spellchecker")[a])b(this).data("spellchecker")[a](c);else{b(this).data("spellchecker",new h(this,a&&a.constructor===Object&&a||null));a&&a.constructor==String&&b(this).data("spellchecker")[a](c)}})}});var h=function(a,c){this.options=b.extend({url:"checkspelling.php",lang:"en",engine:"pspell",addToDictionary:false,wordlist:{action:"after",element:a},suggestBoxPosition:"below", innerDocument:false},c||{});this.$domObj=b(a);this.elements={};this.init()};h.prototype={init:function(){this.createElements();this.$domObj.addClass("spellcheck-container")},check:function(a){var c=this,d=this.$domObj.get(0).nodeName;if(d=="TEXTAREA"||d=="INPUT"){this.type="textarea";d=b.trim(this.$domObj.val().replace(new RegExp("<[^>]+>","g"),"").replace(new RegExp("^[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]+[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]$|\\n|\\t|\\s{2,}","g")," "))}else{this.type= "html";d=b.trim(this.$domObj.text().replace(new RegExp("^[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]+[^a-zA-Z\\u00A1-\\uFFFF]|[^a-zA-Z\\u00A1-\\uFFFF]$|\\n|\\t|\\s{2,}","g")," "))}this.postJson(this.options.url,{text:encodeURIComponent(d).replace(/%20/g,"+")},function(e){c.type=="html"&&c.options.innerDocument?c.highlightWords(e,a):c.buildBadwordsBox(e,a)})},highlightWords:function(a,c){if(a.length){var d=this,e=this.$domObj.html();b.each(a,function(f,g){e=e.replace(new RegExp("([^a-zA-Z\\u00A1-\\uFFFF])("+ g+")([^a-zA-Z\\u00A1-\\uFFFF])","g"),'$1<span class="spellcheck-word-highlight">$2</span>$3')});this.$domObj.html(e).find(".spellcheck-word-highlight").click(function(){d.suggest(this)});c&&c()}else c(true)},buildBadwordsBox:function(a,c){if(a.length){var d=this,e=[];if(b("#spellcheck-badwords").length)this.elements.$badwords=b("#spellcheck-badwords");else b(this.options.wordlist.element)[this.options.wordlist.action](this.elements.$badwords);this.elements.$badwords.empty();b.each(a,function(f,g){if(b.inArray(g, e)===-1){b('<span class="spellcheck-word-highlight">'+g+"</span>").click(function(){d.suggest(this)}).appendTo(d.elements.$badwords).after('<span class="spellcheck-sep">,</span> ');e.push(g)}});b(".spellcheck-sep:last",d.elements.$badwords).addClass("spellcheck-sep-last");c&&c()}else c(true)},suggest:function(a){var c=this;a=b(a);var d=a.offset();this.$curWord=a;if(this.options.innerDocument){this.elements.$suggestBox=this.elements.$body.find("#spellcheck-suggestbox");this.elements.$suggestWords= this.elements.$body.find("#spellcheck-suggestbox-words");this.elements.$suggestFoot=this.elements.$body.find("#spellcheck-suggestbox-foot")}this.elements.$suggestFoot.hide();this.elements.$suggestBox.stop().hide().css({opacity:1,width:"auto",left:d.left+"px",top:this.options.suggestBoxPosition=="above"?d.top-(a.outerHeight()+10)+"px":d.top+a.outerHeight()+"px"}).fadeIn(200);this.elements.$focusHelper.focus();this.elements.$suggestWords.html("<em>Loading..</em>");this.postJson(this.options.url,{suggest:encodeURIComponent(b.trim(a.text()))}, function(e){c.buildSuggestBox(e,d)})},buildSuggestBox:function(a,c){var d=this,e=this.$curWord;this.elements.$suggestWords.empty();for(var f=0;f<(a.length<5?a.length:5);f++)this.elements.$suggestWords.append(b('<a href="#">'+a[f]+"</a>").addClass(!f?"first":"").mousedown(function(g){g.preventDefault();d.replace(this.innerHTML);d.elements.$focusHelper.trigger("blur")}));!f&&this.elements.$suggestWords.append("<em>(no suggestions)</em>");a=window.innerHeight?window.innerHeight:b(window).height();this.elements.$suggestFoot.show(); d.elements.$suggestBox.css({top:this.options.suggestBoxPosition=="above"||c.top+e.outerHeight()+this.elements.$suggestBox.outerHeight()>a+10?c.top-(this.elements.$suggestBox.height()+5)+"px":c.top+e.outerHeight()+"px",width:"auto",left:this.elements.$suggestBox.outerWidth()+c.left>b("body").width()?c.left-this.elements.$suggestBox.width()+e.outerWidth()+"px":c.left+"px"})},hideBox:function(a){this.elements.$suggestBox.fadeOut(250,function(){a&&a()})},replace:function(a){switch(this.type){case "textarea":this.replaceTextbox(a); break;case "html":this.replaceHtml(a);break}},replaceWord:function(a,c){return a.replace(new RegExp("([^a-zA-Z\\u00A1-\\uFFFF])("+this.$curWord.text()+")([^a-zA-Z\\u00A1-\\uFFFF])","g"),"$1"+c+"$3").replace(new RegExp("^("+this.$curWord.text()+")([^a-zA-Z\\u00A1-\\uFFFF])","g"),c+"$2").replace(new RegExp("([^a-zA-Z\\u00A1-\\uFFFF])("+this.$curWord.text()+")$","g"),"$1"+c)},replaceTextbox:function(a){this.removeBadword(this.$curWord);this.$domObj.val(this.replaceWord(this.$domObj.val(),a))},replaceHtml:function(a){var c= this.$domObj.find(".spellcheck-word-highlight:contains("+this.$curWord.text()+")");if(c.length)c.after(a).remove();else{b(this.$domObj).html(this.replaceWord(b(this.$domObj).html(),a));this.removeBadword(this.$curWord)}},ignore:function(){this.type=="textarea"?this.removeBadword(this.$curWord):this.$curWord.after(this.$curWord.html()).remove()},ignoreAll:function(){var a=this;this.type=="textarea"?this.removeBadword(this.$curWord):b(".spellcheck-word-highlight",this.$domObj).each(function(){(new RegExp(a.$curWord.text(), "i")).test(this.innerHTML)&&b(this).after(this.innerHTML).remove()})},removeBadword:function(a){a.next().hasClass("spellcheck-sep")&&a.next().remove();a.remove();b(".spellcheck-sep",this.elements.$badwords).length?b(".spellcheck-sep:last",this.elements.$badwords).addClass("spellcheck-sep-last"):this.remove()},addToDictionary:function(){var a=this;this.hideBox(function(){confirm('Are you sure you want to add the word "'+a.$curWord.text()+'" to the dictionary?')&&a.postJson(a.options.url,{addtodictionary:a.$curWord.text()}, function(){a.ignoreAll();a.check()})})},remove:function(a){a=a||true;this.elements.$body.find(".spellcheck-word-highlight").each(function(){b(this).after(this.innerHTML).remove()});this.elements.$body.find("#spellcheck-badwords, #spellcheck-suggestbox-words, #spellcheck-suggestbox-foot, #spellcheck-suggestbox, #spellcheck-focus-helper").remove();b(this.domObj).removeClass("spellcheck-container");a&&b(this.domObj).data("spellchecker",null)},postJson:function(a,c,d){return b.ajax({type:"POST",url:a, data:b.extend(c,{engine:this.options.engine,lang:this.options.lang}),dataType:"json",cache:false,error:function(){alert("Sorry, there was an error processing the request.")},success:function(e){d&&d(e)}})},createElements:function(){var a=this;this.elements.$body=this.options.innerDocument?this.$domObj.parents().filter("html:first").find("body"):b("body");this.remove(false);this.elements.$focusHelper=b('<input type="text" id="spellcheck-focus-helper" />').blur(function(){a.hideBox()}).prependTo(this.elements.$body); this.elements.$suggestWords=b('<div id ="spellcheck-suggestbox-words"></div>');this.elements.$ignoreWord=b('<a href="#">Ignore Word</a>').click(function(c){c.preventDefault();a.ignore();a.elements.$focusHelper.trigger("blur")});this.elements.$ignoreAllWords=b('<a href="#">Ignore all</a>').click(function(c){c.preventDefault();a.ignoreAll();a.elements.$focusHelper.trigger("blur")});this.elements.$ignoreWordsForever=b('<a href="#" title="ignore word forever (add to dictionary)">Ignore forever</a>').click(function(c){c.preventDefault(); a.addToDictionary();a.elements.$focusHelper.trigger("blur")});this.elements.$suggestFoot=b('<div id="spellcheck-suggestbox-foot"></div>').append(this.elements.$ignoreWord).append(this.elements.$ignoreAllWords).append(this.options.engine=="pspell"&&a.options.addToDictionary?this.elements.$ignoreWordsForever:false);this.elements.$badwords=b('<div id="spellcheck-badwords"></div>');this.elements.$suggestBox=b('<div id="spellcheck-suggestbox"></div>').append(this.elements.$suggestWords).append(this.elements.$suggestFoot).prependTo(this.elements.$body)}}})(jQuery);
